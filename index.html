<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Latiao Finance | Enterprise</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            DEFAULT: '#FF5722', // Latiao Orange
                            dark: '#E64A19',
                            light: '#FFCCBC',
                            bg: '#FFF7F5'
                        },
                        dark: {
                            900: '#121212',
                            800: '#1E1E1E',
                            card: '#252525'
                        }
                    },
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    boxShadow: {
                        'soft': '0 10px 40px -10px rgba(0,0,0,0.08)',
                        'glow': '0 0 20px rgba(255, 87, 34, 0.3)'
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #FAFAFA; color: #1e293b; -webkit-tap-highlight-color: transparent; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        /* Glass Effect */
        .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.6); }
        .glass-dark { background: rgba(30, 30, 30, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.05); }

        /* Animations */
        .animate-slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .tap-effect:active { transform: scale(0.96); transition: transform 0.1s; }
    </style>
</head>
<body>

<div id="root"></div>

<script type="text/babel" data-type="module">
    // --- FIREBASE SETUP ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDIk302oYXye-r4hRE-EB16N6K3T31g1uk",
      authDomain: "latiao-finance.firebaseapp.com",
      projectId: "latiao-finance",
      storageBucket: "latiao-finance.firebasestorage.app",
      messagingSenderId: "858773999156",
      appId: "1:858773999156:web:fe8f4907314f83c9a88461"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const { useState, useEffect, useMemo } = React;

    // --- ICONS HELPER ---
    const Icon = ({ name, size = 20, className, color }) => {
        useEffect(() => { lucide.createIcons(); }, [name]);
        return <i data-lucide={name} width={size} height={size} className={className} style={{color}}></i>;
    };

    // --- CONSTANTS ---
    const CATEGORIES = {
        income: ['Продажі', 'Кешбек', 'Повернення', 'Інше'],
        expense: ['Закупівля (COGS)', 'Реклама', 'Логістика', 'Пакування', 'Зарплата', 'Податки', 'Комісії', 'Оренда', 'Інше']
    };
    const ACCOUNTS = [
        { id: 'mono', name: 'Monobank', type: 'bank', bg: 'bg-gray-900', text: 'text-white' },
        { id: 'nova', name: 'NovaPay', type: 'bank', bg: 'bg-red-600', text: 'text-white' },
        { id: 'cash', name: 'Готівка', type: 'cash', bg: 'bg-green-600', text: 'text-white' }
    ];
    const SMART_RULES = [
        { k: 'Nova', c: 'Логістика' }, { k: 'Gepard', c: 'Логістика' },
        { k: 'Meta', c: 'Реклама' }, { k: 'Google', c: 'Реклама' }, { k: 'Prom', c: 'Реклама' },
        { k: 'NovaPay', c: 'Комісії' }
    ];

    // --- MAIN APP ---
    const App = () => {
        const [user, setUser] = useState(null);
        const [view, setView] = useState('auth'); 
        const [transactions, setTransactions] = useState([]);
        
        // --- AUTH LOGIC ---
        useEffect(() => {
            const unsub = onAuthStateChanged(auth, u => {
                setUser(u);
                if(u) {
                    setView('dashboard');
                    const q = query(collection(db, "transactions"), orderBy("createdAt", "desc"));
                    onSnapshot(q, snap => setTransactions(snap.docs.map(d => ({id: d.id, ...d.data()}))));
                } else {
                    setView('auth');
                }
            });
            return () => unsub();
        }, []);

        // --- MATH ENGINE ---
        const data = useMemo(() => {
            const revenue = transactions.filter(t => t.type === 'income' && !t.isDividend).reduce((s,t) => s+t.amount, 0);
            const cogs = transactions.filter(t => t.cat === 'Закупівля (COGS)').reduce((s,t) => s+t.amount, 0);
            const gross = revenue - cogs;
            const opex = transactions.filter(t => t.type === 'expense' && t.cat !== 'Закупівля (COGS)' && !t.isDividend).reduce((s,t) => s+t.amount, 0);
            const net = gross - opex;
            
            // Cash Flow
            const totalCash = transactions.reduce((s,t) => t.type==='income' ? s+t.amount : s-t.amount, 0);
            const dividends = transactions.filter(t => t.isDividend).reduce((s,t) => s+t.amount, 0);
            
            // Balances
            const balances = { mono: 0, nova: 0, cash: 0 };
            transactions.forEach(t => {
                const accId = ACCOUNTS.find(a => a.name === t.source)?.id || 'cash';
                if(balances[accId] !== undefined) balances[accId] += (t.type==='income' ? t.amount : -t.amount);
            });

            // Runway
            const burn = (cogs + opex) / 30 || 1;
            const runway = (totalCash / burn).toFixed(0);

            return { revenue, cogs, gross, opex, net, totalCash, dividends, balances, runway };
        }, [transactions]);

        // --- COMPONENTS ---

        // 1. AUTH SCREEN
        if (view === 'auth') return <AuthScreen />;

        return (
            <div className="max-w-md mx-auto min-h-screen bg-[#FAFAFA] pb-24 shadow-2xl relative">
                {/* Dynamic Content */}
                <div className="animate-fade-in">
                    {view === 'dashboard' && <Dashboard data={data} txs={transactions} />}
                    {view === 'pnl' && <PnL data={data} txs={transactions} />}
                    {view === 'dividends' && <Dividends data={data} txs={transactions} />}
                    {view === 'ops' && <Operations txs={transactions} />}
                    {view === 'settings' && <Settings user={user} />}
                </div>

                {/* Bottom Navigation */}
                <NavBar current={view} setView={setView} />
            </div>
        );
    };

    // --- SUB-COMPONENTS ---

    const AuthScreen = () => {
        const [email, setEmail] = useState('');
        const [pass, setPass] = useState('');
        const [err, setErr] = useState('');

        const login = async (e) => {
            e.preventDefault();
            try { await signInWithEmailAndPassword(auth, email, pass); } 
            catch { setErr('Доступ заборонено'); }
        };

        return (
            <div className="min-h-screen bg-dark-900 text-white flex flex-col items-center justify-center p-6 relative overflow-hidden">
                <div className="absolute top-[-20%] right-[-20%] w-[500px] h-[500px] bg-brand rounded-full opacity-10 blur-[100px]"></div>
                
                <div className="glass-dark p-8 rounded-[32px] w-full max-w-sm z-10 animate-slide-up border border-white/10">
                    <div className="flex justify-center mb-8">
                        <div className="w-16 h-16 bg-gradient-to-tr from-brand to-orange-500 rounded-2xl flex items-center justify-center text-3xl font-bold shadow-glow text-white">L</div>
                    </div>
                    <h1 className="text-2xl font-bold text-center mb-2 tracking-tight">Latiao Enterprise</h1>
                    <p className="text-gray-400 text-center text-xs uppercase tracking-widest mb-8">Secure Access v6.0</p>
                    
                    <form onSubmit={login} className="space-y-4">
                        <div className="group bg-white/5 border border-white/10 rounded-2xl p-1 transition-colors focus-within:border-brand">
                            <input type="email" placeholder="Email ID" value={email} onChange={e=>setEmail(e.target.value)} 
                                className="w-full bg-transparent p-3 text-white placeholder-gray-500 outline-none text-sm font-medium"/>
                        </div>
                        <div className="group bg-white/5 border border-white/10 rounded-2xl p-1 transition-colors focus-within:border-brand">
                            <input type="password" placeholder="Passcode" value={pass} onChange={e=>setPass(e.target.value)} 
                                className="w-full bg-transparent p-3 text-white placeholder-gray-500 outline-none text-sm font-medium"/>
                        </div>
                        {err && <div className="text-red-400 text-xs text-center font-medium bg-red-500/10 py-2 rounded-lg">{err}</div>}
                        <button className="w-full bg-brand hover:bg-brand-dark text-white font-bold py-4 rounded-2xl shadow-lg shadow-orange-500/20 tap-effect transition-all mt-4">
                            Log In
                        </button>
                    </form>
                </div>
            </div>
        );
    };

    const Dashboard = ({ data, txs }) => {
        const [modal, setModal] = useState(null);

        return (
            <div className="p-6 space-y-6">
                {/* Header */}
                <div className="flex justify-between items-center pt-2">
                    <div>
                        <h1 className="text-2xl font-bold text-gray-900 tracking-tight">Головна</h1>
                        <p className="text-xs text-gray-400 font-medium">{new Date().toLocaleDateString('uk-UA', {weekday: 'long', day:'numeric', month:'long'})}</p>
                    </div>
                    <div className="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center border border-gray-200">
                        <span className="font-bold text-brand">L</span>
                    </div>
                </div>

                {/* Total Balance Card */}
                <div className="bg-gray-900 text-white p-7 rounded-[32px] shadow-soft relative overflow-hidden group tap-effect">
                    <div className="absolute top-0 right-0 w-32 h-32 bg-brand rounded-full blur-[60px] opacity-20 group-hover:opacity-30 transition-opacity"></div>
                    <div className="relative z-10">
                        <div className="flex items-center gap-2 mb-2 text-gray-400 text-xs font-bold uppercase tracking-wider">
                            <Icon name="wallet" size={14}/> Total Cash
                        </div>
                        <div className="text-4xl font-bold tracking-tight mb-6">{data.totalCash.toLocaleString()} ₴</div>
                        <div className="flex gap-2">
                            {ACCOUNTS.map(acc => (
                                <div key={acc.id} className="bg-white/10 backdrop-blur-md px-3 py-1.5 rounded-xl text-xs font-medium border border-white/5">
                                    {acc.name.split(' ')[0]}: {data.balances[acc.id].toLocaleString()}
                                </div>
                            ))}
                        </div>
                    </div>
                </div>

                {/* Metrics Grid */}
                <div className="grid grid-cols-2 gap-4">
                    <div className="bg-white p-5 rounded-[24px] shadow-soft border border-slate-50">
                        <div className="text-xs text-gray-400 font-bold uppercase mb-1">Net Profit</div>
                        <div className={`text-xl font-bold ${data.net >= 0 ? 'text-emerald-600' : 'text-red-500'}`}>{data.net.toLocaleString()}</div>
                        <div className="text-[10px] text-gray-400 mt-2 bg-gray-50 inline-block px-2 py-1 rounded-lg">Margin {((data.net/data.revenue)*100 || 0).toFixed(0)}%</div>
                    </div>
                    <div className="bg-white p-5 rounded-[24px] shadow-soft border border-slate-50">
                        <div className="text-xs text-gray-400 font-bold uppercase mb-1">Runway</div>
                        <div className="text-xl font-bold text-brand">{data.runway} днів</div>
                        <div className="text-[10px] text-gray-400 mt-2 bg-gray-50 inline-block px-2 py-1 rounded-lg">Safety Buffer</div>
                    </div>
                </div>

                {/* Quick Actions */}
                <div className="grid grid-cols-2 gap-4">
                    <button onClick={() => setModal('income')} className="bg-emerald-50 text-emerald-700 py-4 rounded-[20px] font-bold text-sm flex items-center justify-center gap-2 tap-effect hover:bg-emerald-100 transition-colors">
                        <div className="bg-white p-1.5 rounded-full shadow-sm"><Icon name="arrow-down-left" size={16} className="text-emerald-500"/></div>
                         Дохід
                    </button>
                    <button onClick={() => setModal('expense')} className="bg-brand-bg text-brand-dark py-4 rounded-[20px] font-bold text-sm flex items-center justify-center gap-2 tap-effect hover:bg-orange-100 transition-colors">
                        <div className="bg-white p-1.5 rounded-full shadow-sm"><Icon name="arrow-up-right" size={16} className="text-brand"/></div>
                        Витрата
                    </button>
                </div>

                {/* Recent Transactions List */}
                <div>
                    <h3 className="font-bold text-gray-800 mb-4 px-1 text-lg">Стрічка подій</h3>
                    <div className="bg-white rounded-[24px] shadow-soft border border-slate-50 overflow-hidden">
                        {txs.slice(0, 5).map(t => <TxRow key={t.id} t={t} />)}
                    </div>
                </div>

                {modal && <TransactionModal type={modal} close={()=>setModal(null)} />}
            </div>
        );
    };

    const PnL = ({ data }) => (
        <div className="p-6 space-y-6 pt-8 animate-slide-up">
            <h2 className="text-2xl font-bold text-gray-900">P&L Report</h2>
            
            <div className="bg-white rounded-[24px] shadow-soft border border-slate-50 overflow-hidden">
                <div className="p-6 border-b border-gray-50 bg-emerald-50/50">
                    <div className="text-xs text-emerald-600 font-bold uppercase mb-1">Total Revenue</div>
                    <div className="text-3xl font-bold text-emerald-700">+{data.revenue.toLocaleString()} ₴</div>
                </div>
                
                <div className="p-6 space-y-4">
                    <div className="flex justify-between text-sm text-gray-500 font-medium">
                        <span>(-) COGS</span>
                        <span>{data.cogs.toLocaleString()}</span>
                    </div>
                    
                    <div className="p-4 bg-blue-50/50 rounded-2xl border border-blue-100/50">
                        <div className="flex justify-between items-center font-bold text-blue-900 text-lg">
                            <span>Gross Profit</span>
                            <span>{data.gross.toLocaleString()}</span>
                        </div>
                    </div>

                    <div className="pt-2">
                        <div className="text-xs font-bold text-gray-400 uppercase mb-2">OpEx (Витрати)</div>
                        <div className="flex justify-between text-sm font-bold text-gray-700 mb-1">
                            <span>Total OpEx</span>
                            <span className="text-red-500">-{data.opex.toLocaleString()}</span>
                        </div>
                    </div>

                    <div className="pt-4 mt-2 border-t border-dashed border-gray-200">
                        <div className="flex justify-between items-center">
                            <span className="text-lg font-bold text-gray-900">Net Profit</span>
                            <span className={`text-2xl font-bold ${data.net>=0 ? 'text-emerald-600' : 'text-red-600'}`}>
                                {data.net.toLocaleString()}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            <div className="text-center text-xs text-gray-400 font-medium max-w-xs mx-auto">
                * Дивіденди вилучені з розрахунку P&L згідно стандартів управлінського обліку.
            </div>
        </div>
    );

    const Dividends = ({ data, txs }) => {
        const [modal, setModal] = useState(false);
        return (
            <div className="p-6 space-y-6 pt-8 animate-slide-up">
                <div className="bg-gray-900 text-white p-8 rounded-[32px] shadow-soft relative overflow-hidden">
                     <div className="absolute top-0 right-0 w-40 h-40 bg-purple-500 rounded-full blur-[80px] opacity-30"></div>
                     <h2 className="text-xl font-bold mb-1 relative z-10">Дивіденди</h2>
                     <p className="text-xs text-gray-400 mb-8 relative z-10">Profit Distribution Center</p>
                     
                     <div className="grid grid-cols-2 gap-4 mb-8 relative z-10">
                         <div className="bg-white/10 backdrop-blur px-4 py-3 rounded-2xl border border-white/5">
                             <div className="text-[10px] text-gray-400 uppercase font-bold mb-1">Available Net</div>
                             <div className="text-lg font-bold text-emerald-400">{data.net.toLocaleString()}</div>
                         </div>
                         <div className="bg-white/10 backdrop-blur px-4 py-3 rounded-2xl border border-white/5">
                             <div className="text-[10px] text-gray-400 uppercase font-bold mb-1">Withdrawn</div>
                             <div className="text-lg font-bold text-purple-400">{data.dividends.toLocaleString()}</div>
                         </div>
                     </div>
                     
                     <button onClick={()=>setModal(true)} className="relative z-10 w-full bg-white text-gray-900 font-bold py-4 rounded-xl shadow-lg tap-effect">
                         Виплатити
                     </button>
                </div>

                <div className="bg-white rounded-[24px] shadow-soft border border-slate-50 p-6">
                    <h3 className="font-bold text-gray-900 mb-4">Історія виплат</h3>
                    {txs.filter(t=>t.isDividend).map(t => (
                        <div key={t.id} className="flex justify-between py-3 border-b border-gray-50 last:border-0">
                            <div>
                                <div className="font-bold text-gray-800 text-sm">{t.description}</div>
                                <div className="text-xs text-gray-400">{t.date}</div>
                            </div>
                            <div className="font-bold text-gray-900">-{t.amount.toLocaleString()}</div>
                        </div>
                    ))}
                    {txs.filter(t=>t.isDividend).length===0 && <div className="text-center text-sm text-gray-400 py-4">Немає даних</div>}
                </div>
                {modal && <TransactionModal type="dividend" close={()=>setModal(false)} />}
            </div>
        );
    };

    const Operations = ({ txs }) => (
        <div className="p-6 pt-8 animate-slide-up">
            <h2 className="text-2xl font-bold mb-6">Журнал операцій</h2>
            <div className="bg-white rounded-[24px] shadow-soft border border-slate-50 overflow-hidden">
                {txs.map(t => <TxRow key={t.id} t={t} canDelete={true} />)}
            </div>
        </div>
    );

    const Settings = ({ user }) => (
        <div className="p-6 pt-8 space-y-6 animate-slide-up">
            <h2 className="text-2xl font-bold">Налаштування</h2>
            
            <div className="bg-white p-6 rounded-[24px] shadow-soft border border-slate-50">
                <div className="flex items-center gap-3 mb-6">
                    <div className="bg-orange-100 p-2 rounded-lg text-brand"><Icon name="cpu" size={20}/></div>
                    <div>
                        <h3 className="font-bold text-gray-900">Automation Rules</h3>
                        <p className="text-xs text-gray-400">Активна авто-категоризація</p>
                    </div>
                </div>
                <div className="flex flex-wrap gap-2">
                    {SMART_RULES.map((r,i) => (
                        <div key={i} className="text-[10px] font-bold bg-slate-50 border border-slate-100 text-slate-600 px-3 py-1.5 rounded-full">
                            {r.k} → {r.c}
                        </div>
                    ))}
                </div>
            </div>

            <div className="bg-white p-6 rounded-[24px] shadow-soft border border-slate-50">
                <h3 className="font-bold mb-4 text-sm text-gray-500 uppercase">Integrations</h3>
                <div className="space-y-4">
                    <div className="p-4 bg-gray-50 rounded-2xl border border-gray-100 flex justify-between items-center">
                        <div className="flex items-center gap-3">
                            <div className="w-8 h-8 bg-black rounded-lg flex items-center justify-center"><Icon name="credit-card" size={16} className="text-white"/></div>
                            <div>
                                <div className="font-bold text-sm">Monobank</div>
                                <div className="text-[10px] text-green-600 font-bold">● Connected</div>
                            </div>
                        </div>
                        <div className="text-xs font-mono bg-white px-2 py-1 rounded border">•••• 8392</div>
                    </div>
                    <div className="p-4 bg-gray-50 rounded-2xl border border-gray-100 flex justify-between items-center">
                        <div className="flex items-center gap-3">
                            <div className="w-8 h-8 bg-red-600 rounded-lg flex items-center justify-center text-white font-bold text-xs">NP</div>
                            <div>
                                <div className="font-bold text-sm">NovaPay</div>
                                <div className="text-[10px] text-gray-400">Not configured</div>
                            </div>
                        </div>
                        <button className="text-xs font-bold text-brand">Connect</button>
                    </div>
                </div>
            </div>

            <button onClick={()=>signOut(auth)} className="w-full py-4 text-red-500 font-bold bg-white rounded-2xl shadow-sm border border-red-50 tap-effect">
                Log Out
            </button>
        </div>
    );

    // --- SHARED UI ELEMENTS ---

    const NavBar = ({ current, setView }) => {
        const items = [
            { id: 'dashboard', icon: 'layout-grid', l: 'Головна' },
            { id: 'ops', icon: 'list', l: 'Події' },
            { id: 'pnl', icon: 'pie-chart', l: 'P&L' },
            { id: 'dividends', icon: 'gem', l: 'Дивіденди' },
            { id: 'settings', icon: 'settings', l: 'Опції' },
        ];
        return (
            <div className="fixed bottom-6 left-4 right-4 bg-white/90 backdrop-blur-xl border border-white/20 shadow-2xl rounded-[24px] p-2 z-50 flex justify-between items-center">
                {items.map(i => (
                    <button key={i.id} onClick={()=>setView(i.id)} className={`p-3 rounded-2xl transition-all duration-300 ${current===i.id ? 'bg-brand text-white shadow-lg shadow-orange-500/30 scale-105' : 'text-gray-400 hover:text-gray-600'}`}>
                        <Icon name={i.icon} size={22} strokeWidth={current===i.id?2.5:2} />
                    </button>
                ))}
            </div>
        );
    };

    const TxRow = ({ t, canDelete }) => {
        const handleDelete = async () => { if(confirm('Видалити?')) await deleteDoc(doc(db, "transactions", t.id)); };
        const icon = t.isDividend ? 'gem' : (t.type==='income' ? 'arrow-down-left' : 'arrow-up-right');
        const colorClass = t.isDividend ? 'bg-purple-100 text-purple-600' : (t.type==='income' ? 'bg-emerald-100 text-emerald-600' : 'bg-orange-50 text-brand');
        
        return (
            <div className="p-4 border-b border-gray-50 flex justify-between items-center last:border-0 hover:bg-gray-50/50 transition-colors">
                <div className="flex gap-4 items-center">
                    <div className={`w-10 h-10 rounded-2xl flex items-center justify-center ${colorClass}`}>
                        <Icon name={icon} size={18} />
                    </div>
                    <div>
                        <div className="font-bold text-sm text-gray-800">{t.description || 'Операція'}</div>
                        <div className="text-[10px] text-gray-400 font-medium flex gap-2 mt-0.5">
                            <span className="bg-gray-100 px-1.5 py-0.5 rounded">{t.cat}</span>
                            <span>{t.date}</span>
                        </div>
                    </div>
                </div>
                <div className="text-right">
                    <div className={`font-bold text-sm ${t.type==='income'?'text-emerald-600':'text-gray-900'}`}>
                        {t.type==='income'?'+':'-'}{t.amount.toLocaleString()}
                    </div>
                    {canDelete && <button onClick={handleDelete} className="text-gray-300 hover:text-red-500 mt-1"><Icon name="trash-2" size={14}/></button>}
                </div>
            </div>
        );
    };

    const TransactionModal = ({ type, close }) => {
        const [form, setForm] = useState({ amount: '', desc: '', cat: 'Інше', source: 'Monobank ФОП' });
        
        const submit = async () => {
            if(!form.amount) return;
            const isDiv = type === 'dividend';
            let cat = form.cat;
            
            // Smart Rules
            if(!isDiv && form.cat === 'Інше') {
                const rule = SMART_RULES.find(r => form.desc.toLowerCase().includes(r.k.toLowerCase()));
                if(rule) cat = rule.c;
            } else if(isDiv) {
                cat = 'Дивіденди';
            }

            await addDoc(collection(db, "transactions"), {
                amount: Number(form.amount),
                description: form.desc || (isDiv?'Виплата дивідендів':''),
                cat, source: form.source,
                type: (type==='dividend' || type==='expense') ? 'expense' : 'income',
                isDividend: isDiv,
                date: new Date().toLocaleDateString('uk-UA'),
                createdAt: Date.now()
            });
            close();
        };

        const title = type==='dividend' ? 'Виплата дивідендів' : (type==='income' ? 'Новий дохід' : 'Нова витрата');
        const theme = type==='dividend' ? 'bg-slate-900' : (type==='income' ? 'bg-emerald-500' : 'bg-brand');

        return (
            <div className="fixed inset-0 z-50 flex items-end md:items-center justify-center p-4">
                <div className="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" onClick={close}></div>
                <div className="bg-white w-full max-w-sm rounded-[32px] overflow-hidden shadow-2xl z-10 animate-slide-up">
                    <div className={`${theme} p-6 text-white flex justify-between items-center`}>
                        <h3 className="font-bold text-lg flex items-center gap-2">
                             <Icon name={type==='dividend'?'gem':(type==='income'?'arrow-down-left':'arrow-up-right')} size={20}/> {title}
                        </h3>
                        <button onClick={close} className="bg-white/20 p-2 rounded-full hover:bg-white/30"><Icon name="x" size={16}/></button>
                    </div>
                    
                    <div className="p-6 space-y-5">
                        <div>
                            <label className="text-xs font-bold text-gray-400 uppercase ml-1">Сума</label>
                            <input type="number" value={form.amount} onChange={e=>setForm({...form, amount:e.target.value})} className="w-full text-4xl font-bold border-b border-gray-100 py-2 focus:border-brand outline-none text-gray-800 placeholder-gray-200" placeholder="0" autoFocus />
                        </div>

                        {type !== 'dividend' && (
                            <>
                                <div className="space-y-1">
                                    <label className="text-xs font-bold text-gray-400 uppercase ml-1">Опис</label>
                                    <input type="text" value={form.desc} onChange={e=>setForm({...form, desc:e.target.value})} className="w-full bg-gray-50 border border-gray-100 p-4 rounded-2xl text-sm outline-none focus:border-brand transition-colors" placeholder="Напр. Nova Poshta" />
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                    <div className="space-y-1">
                                        <label className="text-xs font-bold text-gray-400 uppercase ml-1">Категорія</label>
                                        <select value={form.cat} onChange={e=>setForm({...form, cat:e.target.value})} className="w-full bg-gray-50 border border-gray-100 p-3 rounded-xl text-sm outline-none">
                                            {CATEGORIES[type==='income'?'income':'expense'].map(c=><option key={c} value={c}>{c}</option>)}
                                        </select>
                                    </div>
                                    <div className="space-y-1">
                                        <label className="text-xs font-bold text-gray-400 uppercase ml-1">Рахунок</label>
                                        <select value={form.source} onChange={e=>setForm({...form, source:e.target.value})} className="w-full bg-gray-50 border border-gray-100 p-3 rounded-xl text-sm outline-none">
                                            {ACCOUNTS.map(a=><option key={a.name} value={a.name}>{a.name}</option>)}
                                        </select>
                                    </div>
                                </div>
                            </>
                        )}

                        {type === 'dividend' && (
                             <div className="bg-orange-50 border border-orange-100 p-4 rounded-2xl text-xs text-orange-800 leading-relaxed">
                                 <strong>Увага:</strong> Ця операція зменшить баланс на рахунку, але не буде відображена як операційна витрата в P&L звіті.
                             </div>
                        )}

                        <button onClick={submit} className={`w-full py-4 rounded-2xl font-bold text-white shadow-lg tap-effect mt-2 ${theme}`}>
                            Підтвердити
                        </button>
                    </div>
                </div>
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>

</body>
</html>
