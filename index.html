<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Latiao Фінанси v2.2 (Filters)</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body { background-color: #F8FAFC; font-family: 'Inter', sans-serif; color: #0F172A; }
        
        /* Custom Colors */
        .text-latiao { color: #FF5722; }
        .bg-latiao { background-color: #FF5722; }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .spinner {
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 2px solid #ffffff;
            width: 20px;
            height: 20px;
            animation: spin 0.8s linear infinite;
        }

        .modal-backdrop {
            background-color: rgba(15, 23, 42, 0.4);
            backdrop-filter: blur(4px);
        }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 3px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- ICONS (Inline SVG to prevent crashes) ---
        const Icons = {
            Dashboard: () => <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>,
            List: () => <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>,
            PieChart: () => <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>,
            ArrowUpRight: () => <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg>,
            DollarSign: () => <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>,
            Settings: () => <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>,
            Check: () => <svg width="12" height="12" fill="none" stroke="currentColor" strokeWidth="3" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>,
            Alert: () => <svg width="14" height="14" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>,
            IncomeArrow: () => <svg width="16" height="16" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><line x1="7" y1="7" x2="17" y2="17"></line><polyline points="17 7 17 17 7 17"></polyline></svg>,
            ExpenseArrow: () => <svg width="16" height="16" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg>,
            Search: () => <svg width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>,
            Filter: () => <svg width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>
        };

        const LOGO_MONO = "https://multicast.com.ua/wp-content/uploads/2024/04/monobank-logo.png";
        const LOGO_NOVA = "https://novapay.credit/wp-content/uploads/2023/10/cropped-cropped-logo.png";
        
        const CATEGORIES = {
            income: ['Продажі', 'Кешбек', 'Інвестиції', 'Повернення', 'Інше'],
            expense: ['Закупівля (COGS)', 'Реклама (Ads)', 'Доставка (Логістика)', 'Пакування', 'Комісії', 'Податки', 'Оренда', 'Зарплата', 'Сервіси', 'Інше']
        };

        const safeJSONParse = (key, fallback) => {
            try { return JSON.parse(localStorage.getItem(key)) || fallback; } 
            catch { return fallback; }
        };

        // --- API & MOCK LOGIC ---
        const fetchMonoAccounts = async (token) => {
            try {
                const response = await fetch('https://api.monobank.ua/personal/client-info', { method: 'GET', headers: { 'X-Token': token } });
                if (!response.ok) throw new Error('API Error');
                const data = await response.json();
                return data.accounts;
            } catch (e) {
                return [
                    { id: 'acc_1', currencyCode: 980, balance: 4520000, type: 'black', iban: 'UA52320000000002600123456789' },
                    { id: 'acc_2', currencyCode: 980, balance: 1250000, type: 'fop', iban: 'UA12320000000002600987654321' }
                ];
            }
        };

        const fetchMonoStatement = async (token, accountId) => {
            const now = Math.floor(Date.now() / 1000);
            const monthAgo = now - (31 * 24 * 60 * 60); 
            try {
                const response = await fetch(`https://api.monobank.ua/personal/statement/${accountId}/${monthAgo}/${now}`, {
                    method: 'GET',
                    headers: { 'X-Token': token }
                });
                if (!response.ok) throw new Error('Statement Error');
                const data = await response.json();
                return data.map(item => ({
                    id: item.id,
                    date: new Date(item.time * 1000).toISOString().split('T')[0],
                    amount: item.amount / 100,
                    type: item.amount > 0 ? 'income' : 'expense',
                    category: null,
                    source: 'monobank',
                    description: item.description,
                    status: 'pending'
                }));
            } catch (e) {
                return [
                    { id: Date.now() + 1, date: '2025-12-27', amount: -4500, type: 'expense', category: 'Реклама (Ads)', source: 'monobank', description: 'FACEBOOK ADS *I5521', status: 'confirmed' },
                    { id: Date.now() + 2, date: '2025-12-27', amount: -20, type: 'expense', category: 'Комісії', source: 'monobank', description: 'Комісія за переказ', status: 'confirmed' },
                    { id: Date.now() + 3, date: '2025-12-26', amount: 12500, type: 'income', category: null, source: 'monobank', description: 'Зарахування коштів', status: 'pending' },
                    { id: Date.now() + 4, date: '2025-12-25', amount: 8400, type: 'income', category: 'Продажі', source: 'monobank', description: 'Оплата замовлення', status: 'confirmed' },
                ];
            }
        };

        // --- COMPONENTS ---

        const Sidebar = ({ activeTab, setActiveTab, connections }) => (
            <div className="w-64 bg-white h-screen fixed left-0 top-0 border-r border-slate-200 flex flex-col z-20">
                <div className="p-8 flex items-center gap-3">
                    <div className="w-10 h-10 bg-latiao rounded-xl flex items-center justify-center text-white font-bold text-xl shadow-lg shadow-orange-200">L</div>
                    <div>
                        <h1 className="text-lg font-bold text-slate-800 leading-tight">Latiao</h1>
                        <div className="text-xs text-slate-400 font-medium tracking-wide">FINANCE</div>
                    </div>
                </div>
                <nav className="flex-1 px-4 space-y-1">
                    {[
                        { id: 'Дашборд', icon: Icons.Dashboard },
                        { id: 'Операції', icon: Icons.List },
                        { id: 'P&L Звіт', icon: Icons.PieChart },
                        { id: 'Cash Flow', icon: Icons.ArrowUpRight },
                        { id: 'Дивіденди', icon: Icons.DollarSign },
                    ].map((item) => (
                        <div key={item.id} onClick={() => setActiveTab(item.id)}
                            className={`flex items-center gap-3 p-3 rounded-xl cursor-pointer transition-all duration-200 group
                            ${activeTab === item.id ? 'bg-orange-50 text-latiao font-semibold' : 'text-slate-500 hover:bg-slate-50 hover:text-slate-800'}`}>
                            <div className={activeTab === item.id ? 'text-latiao' : 'text-slate-400 group-hover:text-slate-600'}>
                                <item.icon />
                            </div>
                            {item.id}
                        </div>
                    ))}
                    
                    <div className="pt-4 mt-4 border-t border-slate-100">
                        <div onClick={() => setActiveTab('Налаштування')}
                            className={`flex items-center gap-3 p-3 rounded-xl cursor-pointer transition-all duration-200
                            ${activeTab === 'Налаштування' ? 'bg-slate-100 text-slate-800 font-semibold' : 'text-slate-500 hover:bg-slate-50 hover:text-slate-800'}`}>
                            <Icons.Settings />
                            Налаштування
                        </div>
                    </div>
                </nav>
                <div className="p-6">
                    <div className="bg-slate-50 rounded-xl p-4 border border-slate-100">
                        <div className="text-xs font-semibold text-slate-400 uppercase mb-3">Інтеграції</div>
                        <div className="space-y-3">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-2 opacity-80">
                                    <img src={LOGO_MONO} className="w-5 h-5 object-contain" />
                                    <span className="text-sm font-medium text-slate-600">Mono</span>
                                </div>
                                <div className={`w-2 h-2 rounded-full shadow-sm ${connections.mono ? 'bg-green-500 shadow-green-200' : 'bg-slate-300'}`}></div>
                            </div>
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-2 opacity-80">
                                    <img src={LOGO_NOVA} className="w-5 h-5 object-contain" />
                                    <span className="text-sm font-medium text-slate-600">Nova</span>
                                </div>
                                <div className={`w-2 h-2 rounded-full shadow-sm ${connections.nova ? 'bg-green-500 shadow-green-200' : 'bg-slate-300'}`}></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        );

        const KPI = ({ title, value, subtext, trend }) => (
            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition-all duration-300 group">
                <div className="flex justify-between items-start mb-2">
                    <div className="text-slate-500 text-sm font-medium">{title}</div>
                    {trend && (
                        <span className={`text-xs px-2 py-1 rounded-full ${trend === 'up' ? 'bg-green-50 text-green-600' : 'bg-red-50 text-red-600'}`}>
                            {trend === 'up' ? '▲ +12%' : '▼ -5%'}
                        </span>
                    )}
                </div>
                <div className="text-3xl font-bold text-slate-800 mb-1 group-hover:text-latiao transition-colors">{value}</div>
                {subtext && <div className="text-xs text-slate-400">{subtext}</div>}
            </div>
        );

        const EditModal = ({ transaction, onClose, onSave }) => {
            const [type, setType] = useState(transaction.type);
            const [category, setCategory] = useState(transaction.category || '');

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center modal-backdrop p-4 animate-fade-in">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden transform transition-all scale-100">
                        <div className="p-6 border-b border-slate-100 flex justify-between items-center">
                            <h3 className="font-bold text-lg text-slate-800">Класифікація</h3>
                            <button onClick={onClose} className="p-2 hover:bg-slate-100 rounded-full text-slate-400 transition-colors">✕</button>
                        </div>
                        <div className="p-6 space-y-6">
                            <div className="text-center py-2">
                                <div className="inline-block px-3 py-1 bg-slate-100 rounded-full text-xs text-slate-500 mb-3 font-mono">{transaction.date}</div>
                                <div className="text-sm font-medium text-slate-600 mb-1">{transaction.description}</div>
                                <div className={`text-4xl font-bold tracking-tight ${type === 'income' ? 'text-emerald-600' : 'text-slate-800'}`}>
                                    {type === 'income' ? '+' : '-'}{Math.abs(transaction.amount).toLocaleString()} ₴
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-2 bg-slate-100 p-1.5 rounded-xl">
                                <button onClick={() => setType('income')} 
                                    className={`py-2.5 rounded-lg text-sm font-bold transition-all duration-200 flex items-center justify-center gap-2
                                    ${type === 'income' ? 'bg-white text-emerald-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>
                                    <Icons.IncomeArrow /> Надходження
                                </button>
                                <button onClick={() => setType('expense')} 
                                    className={`py-2.5 rounded-lg text-sm font-bold transition-all duration-200 flex items-center justify-center gap-2
                                    ${type === 'expense' ? 'bg-white text-red-500 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>
                                    <Icons.ExpenseArrow /> Витрата
                                </button>
                            </div>
                            <div>
                                <label className="block text-xs font-bold text-slate-500 mb-2 uppercase tracking-wider">Оберіть статтю</label>
                                <select value={category} onChange={(e) => setCategory(e.target.value)} 
                                    className="w-full p-4 border border-slate-200 rounded-xl bg-white focus:outline-none focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500 transition-all text-slate-700 font-medium appearance-none cursor-pointer hover:border-slate-300">
                                    <option value="" disabled>-- Не обрано --</option>
                                    {CATEGORIES[type].map(cat => <option key={cat} value={cat}>{cat}</option>)}
                                </select>
                            </div>
                        </div>
                        <div className="p-6 border-t border-slate-100 flex gap-3 bg-slate-50/50">
                            <button onClick={onClose} className="flex-1 py-3.5 border border-slate-200 text-slate-600 font-bold rounded-xl hover:bg-white hover:border-slate-300 transition-all">Скасувати</button>
                            <button onClick={() => onSave({ ...transaction, type, category: category || 'Інше', status: 'confirmed' })} 
                                className="flex-1 py-3.5 bg-latiao text-white font-bold rounded-xl hover:bg-orange-600 shadow-lg shadow-orange-200 hover:shadow-orange-300 transition-all transform active:scale-95">
                                Зберегти
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const Settings = ({ connections, onConnect }) => {
            const [step, setStep] = useState('token');
            const [key, setKey] = useState('');
            const [accounts, setAccounts] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleCheckToken = async () => {
                setLoading(true);
                setError('');
                const fetchedAccounts = await fetchMonoAccounts(key);
                setLoading(false);
                if (fetchedAccounts && fetchedAccounts.length > 0) {
                    setAccounts(fetchedAccounts);
                    setStep('accounts');
                } else {
                    setError('Не вдалося отримати рахунки або API недоступне.');
                }
            };

            const handleSelectAccount = async (accId) => {
                setLoading(true);
                await onConnect('mono', key, accId);
                setLoading(false);
                setStep('connected');
            };

            return (
                <div className="max-w-3xl animate-fade-in">
                    <h2 className="text-3xl font-bold text-slate-800 mb-2">Налаштування</h2>
                    <p className="text-slate-500 mb-8">Керування підключенням до банківських API.</p>

                    <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        <div className="p-8 border-b border-slate-100 bg-slate-50/50">
                            <div className="flex items-center gap-4">
                                <div className="bg-white p-3 rounded-xl border border-slate-100 shadow-sm">
                                    <img src={LOGO_MONO} className="w-8 h-8 object-contain" />
                                </div>
                                <div>
                                    <h3 className="text-lg font-bold text-slate-800">Monobank API</h3>
                                    <p className="text-sm text-slate-500">Автоматичний імпорт виписок</p>
                                </div>
                                {connections.mono && <span className="ml-auto bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold border border-green-200 flex items-center gap-1">ACTIVE <Icons.Check /></span>}
                            </div>
                        </div>

                        <div className="p-8">
                            {!connections.mono && step === 'token' && (
                                <div className="space-y-4 max-w-md">
                                    <div>
                                        <label className="block text-xs font-bold text-slate-500 uppercase mb-2">Введіть X-Token</label>
                                        <input type="password" value={key} onChange={(e) => setKey(e.target.value)} 
                                            className="w-full p-4 border border-slate-200 rounded-xl focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500 outline-none transition-all" 
                                            placeholder="u3..." />
                                        <p className="text-xs text-slate-400 mt-2">Токен можна отримати на api.monobank.ua</p>
                                    </div>
                                    {error && <div className="text-red-500 text-sm flex items-center gap-2"><Icons.Alert /> {error}</div>}
                                    <button onClick={handleCheckToken} disabled={loading || !key} 
                                        className="w-full py-3.5 bg-slate-900 text-white rounded-xl font-bold hover:bg-slate-800 transition-all flex justify-center items-center">
                                        {loading ? <div className="spinner"></div> : 'Далі: Вибір рахунку'}
                                    </button>
                                </div>
                            )}

                            {!connections.mono && step === 'accounts' && (
                                <div className="space-y-4">
                                    <h4 className="font-bold text-slate-700">Оберіть рахунок для синхронізації:</h4>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                        {accounts.map(acc => (
                                            <div key={acc.id} onClick={() => handleSelectAccount(acc.id)}
                                                className="border border-slate-200 rounded-xl p-4 cursor-pointer hover:border-orange-500 hover:shadow-md hover:bg-orange-50/10 transition-all group">
                                                <div className="flex justify-between items-center mb-2">
                                                    <span className="text-xs font-bold uppercase text-slate-400 bg-slate-100 px-2 py-1 rounded">{acc.type}</span>
                                                    <span className="text-xs text-slate-400">{acc.currencyCode === 980 ? 'UAH' : 'USD'}</span>
                                                </div>
                                                <div className="font-mono text-xs text-slate-500 mb-1">{acc.iban}</div>
                                                <div className="text-xl font-bold text-slate-800 group-hover:text-latiao">{(acc.balance / 100).toLocaleString()} ₴</div>
                                            </div>
                                        ))}
                                    </div>
                                    <button onClick={() => setStep('token')} className="text-slate-400 text-sm hover:text-slate-600 underline">Назад</button>
                                </div>
                            )}

                            {connections.mono && (
                                <div className="text-center py-8">
                                    <div className="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">✓</div>
                                    <h4 className="text-xl font-bold text-slate-800 mb-2">Інтеграцію налаштовано!</h4>
                                    <p className="text-slate-500 mb-6">Транзакції за останні 31 день успішно завантажено.</p>
                                    <button onClick={() => { 
                                        localStorage.removeItem('latiao_v2_tx');
                                        localStorage.removeItem('latiao_v2_conn');
                                        window.location.reload(); 
                                    }} className="text-red-500 text-sm font-medium hover:text-red-600 border border-red-200 px-4 py-2 rounded-lg hover:bg-red-50 transition-all">
                                        Відключити та скинути
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        // --- NEW FILTER COMPONENT ---
        const FilterBar = ({ search, setSearch, typeFilter, setTypeFilter, sort, setSort }) => {
            return (
                <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 mb-6 flex flex-col md:flex-row gap-4 items-center justify-between animate-fade-in">
                    {/* Search */}
                    <div className="relative w-full md:w-1/3">
                        <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-slate-400">
                            <Icons.Search />
                        </div>
                        <input 
                            type="text" 
                            placeholder="Пошук..." 
                            value={search}
                            onChange={(e) => setSearch(e.target.value)}
                            className="w-full pl-10 pr-4 py-2.5 border border-slate-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-orange-500/20 focus:border-orange-500 transition-all"
                        />
                    </div>
                    
                    {/* Filters & Sort */}
                    <div className="flex gap-2 w-full md:w-auto overflow-x-auto pb-1 md:pb-0">
                        <select 
                            value={typeFilter} 
                            onChange={(e) => setTypeFilter(e.target.value)}
                            className="bg-slate-50 border border-slate-200 text-slate-700 text-sm rounded-lg focus:ring-orange-500 focus:border-orange-500 block p-2.5"
                        >
                            <option value="all">Всі типи</option>
                            <option value="income">Тільки Доходи</option>
                            <option value="expense">Тільки Витрати</option>
                        </select>

                        <select 
                            value={sort} 
                            onChange={(e) => setSort(e.target.value)}
                            className="bg-slate-50 border border-slate-200 text-slate-700 text-sm rounded-lg focus:ring-orange-500 focus:border-orange-500 block p-2.5"
                        >
                            <option value="dateDesc">Спочатку нові</option>
                            <option value="dateAsc">Спочатку старі</option>
                            <option value="amountDesc">Спочатку великі суми</option>
                            <option value="amountAsc">Спочатку малі суми</option>
                        </select>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [activeTab, setActiveTab] = useState('Операції');
            const [transactions, setTransactions] = useState(() => safeJSONParse('latiao_v2_tx', []));
            const [connections, setConnections] = useState(() => safeJSONParse('latiao_v2_conn', { mono: false, nova: false }));
            const [editingTransaction, setEditingTransaction] = useState(null);

            // --- FILTER STATE ---
            const [searchTerm, setSearchTerm] = useState('');
            const [filterType, setFilterType] = useState('all');
            const [sortBy, setSortBy] = useState('dateDesc');

            useEffect(() => localStorage.setItem('latiao_v2_tx', JSON.stringify(transactions)), [transactions]);
            useEffect(() => localStorage.setItem('latiao_v2_conn', JSON.stringify(connections)), [connections]);

            const handleConnection = async (type, token, accountId) => {
                if (type === 'mono') {
                    const data = await fetchMonoStatement(token, accountId);
                    setTransactions(prev => {
                         const others = prev.filter(t => t.source !== 'monobank');
                         return [...data, ...others].sort((a,b) => new Date(b.date) - new Date(a.date));
                    });
                    setConnections(prev => ({ ...prev, mono: true }));
                }
            };

            const handleSaveTx = (updated) => {
                setTransactions(prev => prev.map(t => t.id === updated.id ? updated : t));
                setEditingTransaction(null);
            };

            // --- FILTER LOGIC ---
            const filteredTransactions = useMemo(() => {
                return transactions
                    .filter(t => {
                        const matchesSearch = t.description.toLowerCase().includes(searchTerm.toLowerCase()) || 
                                              (t.category && t.category.toLowerCase().includes(searchTerm.toLowerCase()));
                        const matchesType = filterType === 'all' || t.type === filterType;
                        return matchesSearch && matchesType;
                    })
                    .sort((a, b) => {
                        if (sortBy === 'dateDesc') return new Date(b.date) - new Date(a.date);
                        if (sortBy === 'dateAsc') return new Date(a.date) - new Date(b.date);
                        if (sortBy === 'amountDesc') return Math.abs(b.amount) - Math.abs(a.amount);
                        if (sortBy === 'amountAsc') return Math.abs(a.amount) - Math.abs(b.amount);
                        return 0;
                    });
            }, [transactions, searchTerm, filterType, sortBy]);

            const revenue = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + Math.abs(t.amount), 0);
            const expenses = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + Math.abs(t.amount), 0);
            const profit = revenue - expenses;

            return (
                <div className="flex min-h-screen">
                    <Sidebar activeTab={activeTab} setActiveTab={setActiveTab} connections={connections} />
                    
                    <main className="flex-1 ml-64 p-10 overflow-y-auto h-screen">
                        <header className="flex justify-between items-center mb-10 animate-fade-in">
                            <div>
                                <h2 className="text-3xl font-bold text-slate-800">{activeTab}</h2>
                                <p className="text-slate-400 mt-1 text-sm font-medium">Сьогодні: {new Date().toLocaleDateString('uk-UA', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                            </div>
                            <div className="flex items-center gap-4 bg-white p-2 pr-4 rounded-full border border-slate-200 shadow-sm">
                                <div className="w-10 h-10 bg-slate-900 rounded-full flex items-center justify-center text-white font-bold">R</div>
                                <div className="text-sm">
                                    <div className="font-bold text-slate-800">Руслан</div>
                                    <div className="text-xs text-slate-500">Власник</div>
                                </div>
                            </div>
                        </header>

                        {activeTab === 'Дашборд' && (
                             <div className="space-y-6 animate-fade-in">
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <KPI title="Виручка (31 день)" value={`${revenue.toLocaleString()} ₴`} trend="up" />
                                    <KPI title="Витрати" value={`${expenses.toLocaleString()} ₴`} trend="down" />
                                    <KPI title="Чистий прибуток" value={`${profit.toLocaleString()} ₴`} subtext={`Маржинальність: ${revenue ? ((profit/revenue)*100).toFixed(1) : 0}%`} />
                                </div>
                                <div className="bg-white p-8 rounded-2xl shadow-sm border border-slate-100 text-center text-slate-400 py-20">
                                    Графіки будуть доступні після накопичення статистики.
                                </div>
                            </div>
                        )}

                        {activeTab === 'Операції' && (
                            <div className="animate-fade-in">
                                <FilterBar 
                                    search={searchTerm} setSearch={setSearchTerm}
                                    typeFilter={filterType} setTypeFilter={setFilterType}
                                    sort={sortBy} setSort={setSortBy}
                                />
                                <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                    <table className="w-full">
                                        <thead className="bg-slate-50 border-b border-slate-100">
                                            <tr>
                                                <th className="p-5 text-xs font-bold text-slate-500 uppercase tracking-wider text-left">Дата</th>
                                                <th className="p-5 text-xs font-bold text-slate-500 uppercase tracking-wider text-left">Опис</th>
                                                <th className="p-5 text-xs font-bold text-slate-500 uppercase tracking-wider text-left">Стаття</th>
                                                <th className="p-5 text-xs font-bold text-slate-500 uppercase tracking-wider text-right">Сума</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {filteredTransactions.length === 0 ? (
                                                <tr><td colSpan="4" className="p-10 text-center text-slate-400">Транзакцій не знайдено.</td></tr>
                                            ) : filteredTransactions.map(t => (
                                                <tr key={t.id} onClick={() => setEditingTransaction(t)} 
                                                    className="hover:bg-orange-50/30 cursor-pointer transition-colors group">
                                                    <td className="p-5 text-sm text-slate-500 font-mono">{t.date}</td>
                                                    <td className="p-5">
                                                        <div className="font-medium text-slate-700 group-hover:text-slate-900">{t.description}</div>
                                                        <div className="text-xs text-slate-400 flex items-center gap-1 mt-1">
                                                            <img src={t.source === 'monobank' ? LOGO_MONO : LOGO_NOVA} className="w-3 h-3 grayscale opacity-70" />
                                                            {t.source}
                                                        </div>
                                                    </td>
                                                    <td className="p-5">
                                                        {!t.category ? (
                                                            <span className="inline-flex items-center gap-1 px-2.5 py-1 rounded-md bg-orange-50 text-orange-600 text-xs font-bold border border-orange-100 group-hover:bg-orange-100 transition-colors">
                                                                <Icons.Alert /> Класифікувати
                                                            </span>
                                                        ) : (
                                                            <span className="px-3 py-1 bg-slate-100 text-slate-600 rounded-lg text-xs font-medium border border-slate-200">{t.category}</span>
                                                        )}
                                                    </td>
                                                    <td className={`p-5 text-right font-bold text-sm ${t.type === 'income' ? 'text-emerald-600' : 'text-slate-800'}`}>
                                                        {t.amount.toLocaleString()} ₴
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {activeTab === 'Налаштування' && <Settings connections={connections} onConnect={handleConnection} />}
                    </main>

                    {editingTransaction && <EditModal transaction={editingTransaction} onClose={() => setEditingTransaction(null)} onSave={handleSaveTx} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
