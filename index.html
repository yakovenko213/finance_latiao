<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Latiao Фінанси v3.0 (Pro P&L)</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body { background-color: #F8FAFC; font-family: 'Inter', sans-serif; color: #0F172A; }
        
        /* Brand Colors */
        .text-latiao { color: #FF5722; }
        .bg-latiao { background-color: #FF5722; }
        .border-latiao { border-color: #FF5722; }
        
        /* Utilities */
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .animate-fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 3px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- ICONS (Safe Inline SVG) ---
        const Icons = {
            Dashboard: () => <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>,
            List: () => <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>,
            PieChart: () => <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>,
            ArrowUpRight: () => <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><line x1="7" y1="17" x2="17" y2="7"></line><polyline points="7 7 17 7 17 17"></polyline></svg>,
            DollarSign: () => <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>,
            Settings: () => <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>,
            Refresh: () => <svg width="14" height="14" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>,
            Search: () => <svg width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>,
            Calculator: () => <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><rect x="4" y="2" width="16" height="20" rx="2"></rect><line x1="8" y1="6" x2="16" y2="6"></line><line x1="16" y1="14" x2="16" y2="18"></line><path d="M16 10h.01"></path><path d="M12 10h.01"></path><path d="M8 10h.01"></path><path d="M12 14h.01"></path><path d="M8 14h.01"></path><path d="M12 18h.01"></path><path d="M8 18h.01"></path></svg>,
            X: () => <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        };

        const LOGO_MONO = "https://multicast.com.ua/wp-content/uploads/2024/04/monobank-logo.png";
        const LOGO_NOVA = "https://novapay.credit/wp-content/uploads/2023/10/cropped-cropped-logo.png";
        
        const CATEGORIES = {
            income: ['Продажі', 'Кешбек', 'Інвестиції', 'Інше'],
            expense: ['Закупівля (COGS)', 'Реклама (Ads)', 'Доставка (Логістика)', 'Пакування', 'Комісії', 'Податки', 'Оренда', 'Зарплата', 'Сервіси', 'Інше']
        };

        // --- HELPERS ---
        const safeJSONParse = (key, fallback) => {
            try { return JSON.parse(localStorage.getItem(key)) || fallback; } 
            catch { return fallback; }
        };

        // --- API SIMULATION ---
        const fetchNewTransactions = () => {
            // Симуляція нових транзакцій для Live Update
            const rand = Math.random();
            if (rand > 0.7) { // 30% шанс на нову транзакцію
                const isIncome = Math.random() > 0.5;
                return [{
                    id: Date.now(),
                    date: new Date().toISOString().split('T')[0],
                    amount: isIncome ? Math.floor(Math.random() * 2000) + 100 : -(Math.floor(Math.random() * 1000) + 50),
                    type: isIncome ? 'income' : 'expense',
                    category: null,
                    source: Math.random() > 0.5 ? 'monobank' : 'novapay',
                    description: isIncome ? 'Нове замовлення (Live)' : 'Автосписання (Live)',
                    status: 'pending'
                }];
            }
            return [];
        };

        // --- COMPONENTS ---

        // 1. Calculator
        const Calculator = ({ onClose }) => {
            const [display, setDisplay] = useState('0');
            const [prev, setPrev] = useState(null);
            const [op, setOp] = useState(null);
            const [waiting, setWaiting] = useState(false);

            const input = (d) => {
                if (waiting) { setDisplay(String(d)); setWaiting(false); } 
                else { setDisplay(display === '0' ? String(d) : display + d); }
            };
            const oper = (nextOp) => {
                const val = parseFloat(display);
                if (prev == null) setPrev(val);
                else if (op) {
                    const res = op === '+' ? prev + val : op === '-' ? prev - val : op === '*' ? prev * val : prev / val;
                    setPrev(res); setDisplay(String(res));
                }
                setWaiting(true); setOp(nextOp);
            };
            const eq = () => { oper('='); setOp(null); setPrev(null); };
            const clr = () => { setDisplay('0'); setPrev(null); setOp(null); setWaiting(false); };

            const Btn = ({ v, cb, bg="bg-slate-50", c="text-slate-800" }) => (
                <button onClick={cb} className={`${bg} ${c} p-4 rounded-xl font-bold text-lg hover:brightness-95 active:scale-95 transition-all shadow-sm`}>{v}</button>
            );

            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/50 backdrop-blur-sm">
                    <div className="bg-white rounded-2xl shadow-2xl w-80 overflow-hidden animate-fade-in border border-slate-200">
                        <div className="bg-slate-900 p-4 flex justify-between items-center text-white">
                            <span className="font-bold flex gap-2"><Icons.Calculator/> Калькулятор</span>
                            <button onClick={onClose}><Icons.X/></button>
                        </div>
                        <div className="p-6 text-right bg-slate-50 text-3xl font-mono font-bold text-slate-800 border-b">{Number(display).toLocaleString('uk-UA', {maximumFractionDigits: 6})}</div>
                        <div className="p-4 grid grid-cols-4 gap-2 bg-white">
                            <Btn v="C" cb={clr} bg="bg-red-50" c="text-red-500"/>
                            <Btn v="/" cb={() => oper('/')} bg="bg-orange-50" c="text-orange-600"/>
                            <Btn v="*" cb={() => oper('*')} bg="bg-orange-50" c="text-orange-600"/>
                            <Btn v="-" cb={() => oper('-')} bg="bg-orange-50" c="text-orange-600"/>
                            {[7,8,9].map(n => <Btn key={n} v={n} cb={() => input(n)}/>)}
                            <Btn v="+" cb={() => oper('+')} bg="bg-orange-50" c="text-orange-600"/>
                            {[4,5,6].map(n => <Btn key={n} v={n} cb={() => input(n)}/>)}
                            <Btn v="=" cb={eq} bg="bg-latiao row-span-2 flex items-center justify-center" c="text-white"/>
                            {[1,2,3].map(n => <Btn key={n} v={n} cb={() => input(n)}/>)}
                            <Btn v="0" cb={() => input(0)} bg="col-span-2 bg-slate-50"/>
                            <Btn v="." cb={() => input('.')}/>
                        </div>
                    </div>
                </div>
            );
        };

        // 2. Sidebar
        const Sidebar = ({ activeTab, setActiveTab }) => (
            <div className="w-64 bg-white h-screen fixed left-0 top-0 border-r border-slate-200 flex flex-col z-20">
                <div className="p-8 flex items-center gap-3">
                    <div className="w-10 h-10 bg-latiao rounded-xl flex items-center justify-center text-white font-bold text-xl shadow-lg shadow-orange-200">L</div>
                    <div>
                        <h1 className="text-lg font-bold text-slate-800 leading-tight">Latiao</h1>
                        <div className="text-xs text-slate-400 font-medium tracking-wide">FINANCE PRO</div>
                    </div>
                </div>
                <nav className="flex-1 px-4 space-y-1">
                    {[
                        { id: 'Дашборд', icon: Icons.Dashboard },
                        { id: 'Операції', icon: Icons.List },
                        { id: 'P&L Звіт', icon: Icons.PieChart },
                        { id: 'Cash Flow', icon: Icons.ArrowUpRight },
                        { id: 'Налаштування', icon: Icons.Settings },
                    ].map((item) => (
                        <div key={item.id} onClick={() => setActiveTab(item.id)}
                            className={`flex items-center gap-3 p-3 rounded-xl cursor-pointer transition-all duration-200 group
                            ${activeTab === item.id ? 'bg-orange-50 text-latiao font-semibold' : 'text-slate-500 hover:bg-slate-50 hover:text-slate-800'}`}>
                            <div className={activeTab === item.id ? 'text-latiao' : 'text-slate-400 group-hover:text-slate-600'}>
                                <item.icon />
                            </div>
                            {item.id}
                        </div>
                    ))}
                </nav>
            </div>
        );

        // 3. P&L Report Component (CORE FEATURE)
        const PnLReport = ({ transactions }) => {
            // Logic for P&L
            const report = useMemo(() => {
                const incomeTx = transactions.filter(t => t.type === 'income');
                const expenseTx = transactions.filter(t => t.type === 'expense');

                const revenue = incomeTx.reduce((sum, t) => sum + t.amount, 0);
                
                // COGS (Cost of Goods Sold)
                const cogsTx = expenseTx.filter(t => t.category === 'Закупівля (COGS)');
                const cogs = Math.abs(cogsTx.reduce((sum, t) => sum + t.amount, 0));
                
                const grossProfit = revenue - cogs;
                const grossMargin = revenue ? (grossProfit / revenue) * 100 : 0;

                // OpEx (Operating Expenses) - everything else
                const opexTx = expenseTx.filter(t => t.category !== 'Закупівля (COGS)');
                const opexTotal = Math.abs(opexTx.reduce((sum, t) => sum + t.amount, 0));
                
                // Group OpEx by category
                const opexBreakdown = {};
                opexTx.forEach(t => {
                    const cat = t.category || 'Не класифіковано';
                    opexBreakdown[cat] = (opexBreakdown[cat] || 0) + Math.abs(t.amount);
                });

                const netProfit = grossProfit - opexTotal;
                const netMargin = revenue ? (netProfit / revenue) * 100 : 0;

                return { revenue, cogs, grossProfit, grossMargin, opexTotal, opexBreakdown, netProfit, netMargin };
            }, [transactions]);

            const Row = ({ label, value, percent, bold = false, indent = false, color = "text-slate-800" }) => (
                <div className={`flex justify-between items-center py-3 border-b border-slate-50 hover:bg-slate-50 px-4 rounded-lg transition-colors ${bold ? 'font-bold bg-slate-50/50' : ''}`}>
                    <div className={`${indent ? 'pl-8 text-slate-500 text-sm' : 'text-slate-700'}`}>{label}</div>
                    <div className="flex items-center gap-8">
                        <div className="text-xs text-slate-400 w-12 text-right">{percent ? `${percent.toFixed(1)}%` : '-'}</div>
                        <div className={`w-32 text-right ${color}`}>{value.toLocaleString()} ₴</div>
                    </div>
                </div>
            );

            return (
                <div className="max-w-4xl animate-fade-in space-y-6">
                    <div className="flex justify-between items-end">
                        <div>
                            <h2 className="text-2xl font-bold text-slate-800">Звіт про фінансові результати (P&L)</h2>
                            <p className="text-slate-400 text-sm">Всі показники розраховані автоматично на основі транзакцій.</p>
                        </div>
                        <div className="bg-white px-4 py-2 rounded-lg border border-slate-200 text-sm font-medium text-slate-600 shadow-sm">
                            Цей місяць
                        </div>
                    </div>

                    <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                        {/* Header */}
                        <div className="bg-slate-50 p-4 flex justify-between text-xs font-bold text-slate-500 uppercase tracking-wider border-b border-slate-200">
                            <div>Стаття</div>
                            <div className="flex gap-8 pr-4">
                                <div className="w-12 text-right">% Доходу</div>
                                <div className="w-32 text-right">Сума</div>
                            </div>
                        </div>

                        {/* Revenue Section */}
                        <div className="p-2">
                            <Row label="Виручка (Sales Revenue)" value={report.revenue} percent={100} bold color="text-emerald-600" />
                            <Row label="Собівартість (COGS)" value={-report.cogs} percent={(report.cogs/report.revenue)*100} indent color="text-red-500" />
                            
                            <div className="my-2 border-t border-slate-100"></div>
                            
                            <Row label="Валовий прибуток (Gross Profit)" value={report.grossProfit} percent={report.grossMargin} bold color="text-slate-900" />
                            
                            <div className="my-4">
                                <div className="px-4 text-xs font-bold text-slate-400 uppercase mb-2">Операційні витрати (OpEx)</div>
                                {Object.entries(report.opexBreakdown).map(([cat, val]) => (
                                    <Row key={cat} label={cat} value={-val} percent={(val/report.revenue)*100} indent />
                                ))}
                                <Row label="Всього витрат" value={-report.opexTotal} percent={(report.opexTotal/report.revenue)*100} bold indent />
                            </div>

                            <div className="bg-slate-900 text-white rounded-xl mx-2 mt-4 p-4 flex justify-between items-center shadow-lg">
                                <div>
                                    <div className="text-sm text-slate-400">Чистий прибуток (Net Profit)</div>
                                    <div className="text-xs text-emerald-400">Net Margin: {report.netMargin.toFixed(1)}%</div>
                                </div>
                                <div className="text-3xl font-bold">{report.netProfit.toLocaleString()} ₴</div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // 4. Main App
        const App = () => {
            const [activeTab, setActiveTab] = useState('Операції');
            const [transactions, setTransactions] = useState(() => safeJSONParse('latiao_v3_tx', []));
            const [lastUpdated, setLastUpdated] = useState(new Date());
            const [showCalc, setShowCalc] = useState(false);

            // Filter States
            const [search, setSearch] = useState('');
            const [filterType, setFilterType] = useState('all');

            // Persistence
            useEffect(() => localStorage.setItem('latiao_v3_tx', JSON.stringify(transactions)), [transactions]);

            // AUTO-UPDATE LOGIC (Polling every 60s)
            useEffect(() => {
                const interval = setInterval(() => {
                    const newTx = fetchNewTransactions();
                    if (newTx.length > 0) {
                        setTransactions(prev => [...newTx, ...prev]);
                    }
                    setLastUpdated(new Date());
                }, 60000); // 1 хвилина

                return () => clearInterval(interval);
            }, []);

            // Filter Logic
            const filteredTx = useMemo(() => {
                return transactions.filter(t => {
                    const s = search.toLowerCase();
                    const matchesSearch = t.description?.toLowerCase().includes(s) || t.category?.toLowerCase().includes(s);
                    const matchesType = filterType === 'all' || t.type === filterType;
                    return matchesSearch && matchesType;
                }).sort((a,b) => b.id - a.id);
            }, [transactions, search, filterType]);

            // Edit Transaction Handler
            const updateTx = (id, fields) => {
                setTransactions(prev => prev.map(t => t.id === id ? { ...t, ...fields, status: 'confirmed' } : t));
            };

            return (
                <div className="flex min-h-screen">
                    <Sidebar activeTab={activeTab} setActiveTab={setActiveTab} />
                    
                    <main className="flex-1 ml-64 p-10 overflow-y-auto h-screen bg-[#F8FAFC]">
                        {/* Header */}
                        <header className="flex justify-between items-center mb-8 animate-fade-in">
                            <div>
                                <h2 className="text-3xl font-bold text-slate-800">{activeTab}</h2>
                                <div className="flex items-center gap-2 mt-1">
                                    <span className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
                                    <p className="text-slate-400 text-xs font-medium">
                                        Система активна • Оновлено: {lastUpdated.toLocaleTimeString()}
                                    </p>
                                </div>
                            </div>
                            <div className="flex items-center gap-4 bg-white p-2 pr-4 rounded-full border border-slate-200 shadow-sm">
                                <div className="w-10 h-10 bg-slate-900 rounded-full flex items-center justify-center text-white font-bold">R</div>
                                <div className="text-sm"><div className="font-bold text-slate-800">Руслан</div></div>
                            </div>
                        </header>

                        {/* Content */}
                        {activeTab === 'P&L Звіт' && <PnLReport transactions={transactions} />}
                        
                        {activeTab === 'Операції' && (
                            <div className="animate-fade-in space-y-6">
                                {/* Filters */}
                                <div className="bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex gap-4">
                                    <div className="relative flex-1">
                                        <div className="absolute top-3 left-3 text-slate-400"><Icons.Search /></div>
                                        <input type="text" placeholder="Пошук..." value={search} onChange={e => setSearch(e.target.value)} 
                                            className="w-full pl-10 pr-4 py-2 border border-slate-200 rounded-lg focus:outline-none focus:border-orange-500" />
                                    </div>
                                    <select value={filterType} onChange={e => setFilterType(e.target.value)} className="border border-slate-200 rounded-lg px-4 py-2 bg-slate-50">
                                        <option value="all">Всі типи</option>
                                        <option value="income">Доходи</option>
                                        <option value="expense">Витрати</option>
                                    </select>
                                </div>

                                {/* Table */}
                                <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                    <table className="w-full">
                                        <thead className="bg-slate-50 border-b border-slate-200">
                                            <tr>
                                                <th className="p-5 text-left text-xs font-bold text-slate-500 uppercase">Дата</th>
                                                <th className="p-5 text-left text-xs font-bold text-slate-500 uppercase">Опис</th>
                                                <th className="p-5 text-left text-xs font-bold text-slate-500 uppercase">Стаття</th>
                                                <th className="p-5 text-right text-xs font-bold text-slate-500 uppercase">Сума</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {filteredTx.length === 0 ? <tr><td colSpan="4" className="p-10 text-center text-slate-400">Немає операцій</td></tr> :
                                            filteredTx.map(t => (
                                                <tr key={t.id} className="hover:bg-orange-50/30 transition-colors group">
                                                    <td className="p-5 text-sm text-slate-500 font-mono">{t.date}</td>
                                                    <td className="p-5">
                                                        <div className="font-medium text-slate-700">{t.description}</div>
                                                        <div className="text-xs text-slate-400 flex items-center gap-1 mt-1">
                                                            <img src={t.source === 'monobank' ? LOGO_MONO : LOGO_NOVA} className="w-3 h-3 grayscale opacity-60" /> {t.source}
                                                        </div>
                                                    </td>
                                                    <td className="p-5">
                                                        {t.category ? (
                                                            <span className="px-2 py-1 bg-slate-100 rounded text-xs text-slate-600 border border-slate-200">{t.category}</span>
                                                        ) : (
                                                            <select onChange={(e) => updateTx(t.id, { category: e.target.value })} className="text-xs border border-orange-200 bg-orange-50 text-orange-600 rounded px-2 py-1 focus:outline-none cursor-pointer">
                                                                <option value="">+ Класифікувати</option>
                                                                {CATEGORIES[t.type].map(c => <option key={c} value={c}>{c}</option>)}
                                                            </select>
                                                        )}
                                                    </td>
                                                    <td className={`p-5 text-right font-bold text-sm ${t.type === 'income' ? 'text-emerald-600' : 'text-slate-800'}`}>
                                                        {t.amount.toLocaleString()} ₴
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                        
                        {(activeTab !== 'P&L Звіт' && activeTab !== 'Операції') && (
                            <div className="text-center py-20 text-slate-400">Розділ у розробці...</div>
                        )}
                    </main>

                    {/* Floating FAB for Calc */}
                    <button onClick={() => setShowCalc(true)} className="fixed bottom-8 right-8 bg-slate-900 text-white p-4 rounded-full shadow-xl hover:bg-latiao hover:scale-110 transition-all z-50">
                        <Icons.Calculator />
                    </button>

                    {showCalc && <Calculator onClose={() => setShowCalc(false)} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
